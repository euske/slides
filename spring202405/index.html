<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Yusuke Shinyama">
<meta name="keywords" content="Spring Framework, Spring Boot, フレームワーク, 制御の反転, Inversion of Control, DI, 依存注入, Dependency Injection">
<meta name="description" content="Spring Boot 基本的な概念の解説。">
<meta name="twitter:card" content="summary" />
<meta property="og:type" content="website" />
<meta property="og:title" content="Spring Boot 入門" />
<meta property="og:url" content="https://euske.github.io/slides/spring202501/index.html" />
<meta property="og:description" content="Spring Boot 基本的な概念の解説。" />
<title>Spring Boot 入門</title>
<style><!--
body { line-height: 1.5; }
h1 { border-bottom: solid 4px #000088; }
h2 { border-bottom: solid 2px #000088; }
h3 { border-bottom: solid 1px #000088; }
table { border-collapse: collapse; margin-left: auto; margin-right: auto; }
td { padding: 4px; }
kbd { outline: 1px solid black; padding: 2px; }
pre { outline: 1px solid black; padding: 4px; overflow: auto; }
mark { font-weight: bold; }
pre, code { background: #ddd; font-size: 120%; font-family: courier; }
img { max-width: 80vw; height: auto; }
dt { text-decoration: underline; font-weight: bold; }
u { color: #880000; font-weight: bold; }
.spacy > li { margin-top: 2em; }
.author { text-align: right; }
.figure { outline: 1px solid black; padding: 0.5em; margin: 1em; display: flex; justify-content: center; align-items: flex-end; text-align: center; gap: 2em; background: white; }
.figure .caption { font-size: 80%; font-weight: bold; }
.notice { background: #ffcc00; outline: 2px solid black; padding: 1em; margin: 1em; }
.formula { background: #88ff88; outline: 2px solid black; padding: 1em; margin: 1em; }
.formula dt { margin-top: 1em; }
.title { display: flex; justify-content: center; font-size: 120%; font-weight: bold; border-bottom: 1px solid black; }
.note { background: #88ffff; outline: 2px solid black; padding: 1em; margin: 1em; }
pre em { color: #008800; }
code em { color: #000088; }
pre.small { font-size: 75%; }
.error { color: red; font-weight: bold; }
.exercise { outline: 2px solid black; padding: 1em; margin: 1em; }
.exercise > .header { font-size: 120%; font-weight: bold; border-bottom: solid 1px red; border-left: 4px solid red; padding-left: 8px; }
.file { outline: 2px solid black; padding: 1em; margin: 1em; }
.file > .header { font-weight: bold; color: white; background: #000088; margin-bottom: 4px; padding-left: 1em; }
.file pre { margin: 0; }

.g { background: #eeeeee; }
.bgr { background: #ffbbff; }
.bgg { background: #88ff88; }
.bgy { background: #ffff88; }
.bgb { background: #88ffff; }

.noinj { background: #ff88ff; }
.depinj { background: #88ff88; }
--></style>
</head>
<body>
<div class=nav>
<a href="../index.html">&lt; もどる</a>
</div>

<h1>Spring Boot 入門</h1>
<div class=author>
Yusuke Shinyama, May. 2024
</div>

<ol>
  <li> <a href="#setup">はじめの準備</a>
  <li> <a href="#initializr">Spring Initializr による雛形アプリ生成</a>
  <li> <a href="#controller">最初のTDD - TodoControllerの作成</a>
  <li> <a href="#repository">TodoRepositoryの作成</a>
  <li> <a href="#post">POSTエンドポイントの作成</a>
  <li> <a href="#conclusion">おわりに・参考文献</a>
</ol>

<div class=exercise>
<div class=header>今回作りたいもの:</div>
<p>
  PostgreSQL + Spring Boot を使った Todo アプリのバックエンド。
  以下のAPIエンドポイントを提供する:
<ol type=a>
  <li> <code>GET /todos</code> を実行すると、データベースにある Todo 項目すべてを JSON形式で返す。
<pre>
[{"id":2, "text":"Buy milk."}, {"id":5, "text":"Clean up."}]
</pre>
  <li> <code>POST /todos</code> を実行すると、与えられた Todo をデータベースに追加する。
    このとき、新しく追加された Todo ID を返す。
<pre>
{"text": "Hello!"}
</pre>
  <li> <code>GET /todos/2</code> を実行すると、与えられた IDをもつ Todo 項目ひとつをJSON形式で返す。
<pre>
{"id":2, "text":"Buy milk."}
</pre>
  <li> <code>DELETE /todos/2</code> を実行すると、与えられた IDをもつ Todo 項目をデータベースから削除する。
</ol>
</div>


<h2 id="setup">1. はじめの準備</h2>

<ol class=spacy>

  <li> IntelliJ IDEA Community Edition <strong>(Ultimateではない)</strong> をダウンロードし、インストールする。
  <ul>
    <li> <a target="_blank" href="https://www.jetbrains.com/idea/download/">Download IntelliJ IDEA Community Edition</a>
  </ul>

  <li> Java SDK をダウンロード・インストールする。
  <ul>
    <li> <kbd>Project Structure...</kbd> → <kbd>SDKs</kbd> で <kbd>+</kbd> をクリックし、<kbd>Download JDK...</kbd> を選択。
    <li> Version: <kbd>21</kbd>, Vendor: <kbd>Amazon Colletto 21.0</kbd> を選択。
    <li> 一般に、最新バージョンよりも少し「枯れた」バージョンのほうが問題が少ない。
  </ul>

  <li> PostgreSQL が起動していることを確認する:
<pre>
$ <strong>brew services info postgresql</strong>
postgresql&commat;14 (homebrew.mxcl.postgresql@14)
Running: ✔
Loaded: ✔
Schedulable: ✘
</pre>

  <li> データベース tododb を作成する:
<pre>
$ <strong>createdb tododb</strong>
</pre>
</ol>


<h2 id="initializr">2. Spring Initializr による雛形アプリ生成</h2>

<ol class=spacy>

  <li> <a target="_blank" href="https://start.spring.io/#!type=gradle-project-kotlin&amp;language=kotlin&amp;packaging=jar&amp;groupId=com.example&amp;artifactId=todoApp&amp;name=todoApp&amp;description=Sample%20Spring%20Boot%20Todo%20app&amp;packageName=com.example.todoApp&amp;dependencies=web,data-jdbc,flyway,postgresql">Spring Initializr</a> を使って雛形アプリを生成し、ダウンロードする。
    <ul>
      <li> Spring Web (Webアプリ)
      <li> Spring Data JDBC (データベース接続)
      <li> Flyway Migration (マイグレーションツール)
      <li> PostgreSQL Driver (PostgreSQL用ドライバ)
    </ul>

  <li> IntelliJ IDEA CE で開く。

  <li> application.properties を変更:
<div class=file>
<div>src/main/resources/application.properties:</div>
<pre>
spring.application.name=todoApp
spring.datasource.url=jdbc:postgresql://localhost/tododb
spring.datasource.username=postgres
spring.datasource.password=postgres
spring.datasource.driverClassName=org.postgresql.Driver
</pre>
</div>

  <li> index.html を新規作成する (staticフォルダで <kbd>Command &#x2318;</kbd> + <kbd>N</kbd>):
<div class=file>
<div>src/main/resources/static/index.html:</div>
<pre>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
Welcome!
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div>

  <li> IntelliJ の画面右上のメニューから
    <kbd>todoApp [bootRun]</kbd> を選択すると、アプリが起動する。
<div class=figure>
  <img src="bootrun.png">
</div>

  <li> <a target="_blank" href="http://localhost:8080/">http://localhost:8080/</a> にアクセスし、
    "Welcome!" テキストが見えることを確認する。

<div class=formula>
<div class=title>Javaの基本概念</div>
<dl>
  <dt> Java言語、classファイル、jarファイル
  <dd> Javaソースコード (<code>xxx.java</code>) をコンパイルすると、
    classファイル (<code>xxx.class</code>) が生成される。
    jarファイル (<code>xxx.jar</code>) は複数のclassファイルをまとめたもので、
    JVM (Java Virtual Machine) と呼ばれる仮想マシンで実行する。
<div class=figure>
<div>
  <svg xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="1.1" width="540" height="80">
    <marker id="arrow" viewBox="-5 -5 10 10" orient="auto">
      <polygon points="-5,-5 5,0 -5,5" fill="black" stroke="none" />
    </marker>
    <g stroke="black" stroke-width="1" fill="none">
      <rect x="10" y="10" width="120" height="60" />
      <rect x="210" y="10" width="120" height="60" />
      <rect x="410" y="10" width="120" height="60" />
    </g>
    <g stroke="black" stroke-width="4" fill="none" marker-end="url(#arrow)">
      <path d="M130,40 l75,0" />
      <path d="M330,40 l75,0" />
    </g>
    <g text-anchor="middle" style="font-size: 75%;">
      <text x="70" y="40">Java</text>
      <text x="70" y="55">ソースコード</text>
      <text x="270" y="40">class</text>
      <text x="270" y="55">ファイル</text>
      <text x="470" y="40">jar</text>
      <text x="470" y="55">ファイル</text>
    </g>
  </svg>
</div>
</div>
  <dt> Kotlin言語
  <dd> Javaを改良したもの。Javaと同じく、classファイルにコンパイルされ、JVMで実行できる。
    <div class=figure>
<div>
  <svg xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="1.1" width="540" height="80">
    <marker id="arrow" viewBox="-5 -5 10 10" orient="auto">
      <polygon points="-5,-5 5,0 -5,5" fill="black" stroke="none" />
    </marker>
    <g stroke="black" stroke-width="1" fill="none">
      <rect x="10" y="10" width="120" height="60" />
      <rect x="210" y="10" width="120" height="60" />
      <rect x="410" y="10" width="120" height="60" />
    </g>
    <g stroke="black" stroke-width="4" fill="none" marker-end="url(#arrow)">
      <path d="M130,40 l75,0" />
      <path d="M330,40 l75,0" />
    </g>
    <g text-anchor="middle" style="font-size: 75%;">
      <text x="70" y="40">Kotlin</text>
      <text x="70" y="55">ソースコード</text>
      <text x="270" y="40">class</text>
      <text x="270" y="55">ファイル</text>
      <text x="470" y="40">jar</text>
      <text x="470" y="55">ファイル</text>
    </g>
  </svg>
</div>
</div>
  <dt> アノテーション (annotation) 
  <dd> JavaおよびKotlinのコードには、アノテーションをつけることができる。
    アノテーションはコメントに似ているが、コメントは人間が読むのに対し、
    アノテーションはプログラムによって解析される。
    Java/Kotlin では、クラスや関数 (メソッド)、変数に対してアノテーションをつけることができる。
    Spring Boot では、アノテーションを多用している。
<pre>
<mark>@ClassAnnotation</mark>
class MyClass {
  <mark>@MethodAnnotation</mark>
  fun foo() {
    <mark>@VariableAnnotation</mark>
    val x = 123
  }
}
</pre>
  <dt> JDBC (Java Database Connectivity)
  <dd> Java/KotlinでSQLデータベースにアクセスするための統一規格。
    MySQL, PostgreSQL, Oracleなどのドライバが用意されており、
    ドライバを切り替えることで多様なデータベースエンジンにアクセスできる。
</dl>
</div>

</ol>

<h3 id="gradle">コマンドラインを使ったビルドと起動</h3>
<p>
  IntelliJ を使わず、コマンドラインからアプリのビルド・起動をする場合は、
  以下のようにする:
</p>
<blockquote><pre>
$ <strong>./gradlew build</strong>  <em>(アプリのビルドおよびテスト)</em>
Starting a Gradle Daemon, 1 stopped Daemon could not be reused, use --status for details
...

BUILD SUCCESSFUL in 11s
9 actionable tasks: 5 executed, 4 up-to-date

$ <strong>./gradlew bootrun</strong>  <em>(アプリの実行)</em>
&gt; Task :bootRun
  .   ____          _            __ _ _
 /&Backslash;&Backslash; / ___'_ __ _ _(_)_ __  __ _ &Backslash; &Backslash; &Backslash; &Backslash;
( ( )&Backslash;___ | '_ | '_| | '_ &Backslash;/ _` | &Backslash; &Backslash; &Backslash; &Backslash;
 &Backslash;&Backslash;/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_&Backslash;__, | / / / /
 =========|_|==============|___/=/_/_/_/

 :: Spring Boot ::                (v3.3.0)
...
</pre></blockquote>

<h2 id="controller">3. 最初のテスト駆動開発 - TodoControllerの作成</h2>

<ol class=spacy>
<li> まず TodoAppApplicationTests.kt に、以下のように書く:
<pre>
package com.example.todoApp

import org.hamcrest.MatcherAssert.assertThat
import org.hamcrest.Matchers.*
import org.junit.jupiter.api.Test
import org.springframework.boot.test.context.SpringBootTest

@SpringBootTest
class TodoAppApplicationTests {

    @Test
    fun contextLoads() {
    }

<div class=bgy>    @Test
    fun `最初のテスト`() {
        assertThat(1+2, equalTo(3))
    }
</div>}
</pre>

<ul>
  <li> <code>@Test</code> アノテーションがついているメソッドは、テストとして実行される。
  <li> <code>fun `~`</code> の部分には、テスト名を書く。
  <li> <code>assertThat(1+2, equalTo(3))</code> は「1+2 の結果が 3 に等しい」ことをチェックしている。
  <li> <kbd><svg xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="1.1" width="10" height="10">
       <polygon fill=green stroke=none points="0,0 10,5 0,10" />
       </svg></kbd> ボタンを押してテストを実行し、成功していることを確認する。
</ul>

<div class=note>
<div class=title>ぜひとも覚えたい IntelliJ IDEA の機能 その1</div>
<p>
コード中の<span class=error>赤色になっている部分</span>で
<kbd>Option</kbd> + <kbd>Return</kbd> を押すと、
その問題を解決するための手段を提案してくれる。
</p>
</div>

<li> TodoAppApplicationTests を以下のように変更する:
<pre>
@SpringBootTest(<span class=bgy>webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT</span>)
class TodoAppApplicationTests(
<div class=bgy>    @Autowired val restTemplate: TestRestTemplate, 
    @LocalServerPort val port: Int
</div>) {
    ...

<div class=bgy>    @Test
    fun `GETリクエストはOKステータスを返す`() {
        <em>// localhost/todos に GETリクエストを発行する。</em>
        val response = restTemplate.getForEntity("http://localhost:$port/todos", String::class.java)
        <em>// レスポンスのステータスコードは OK である。</em>
        assertThat(response.statusCode, equalTo(HttpStatus.OK))
    }
</div>
    ...
</pre>

<ul>
  <li> <kbd><svg xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="1.1" width="10" height="10">
       <polygon fill=green stroke=none points="0,0 10,5 0,10" />
       </svg></kbd> ボタンを押してテストを実行し、失敗していることを確認する。
</ul>

<div class=formula>
<div class=title>Spring における「依存注入 (DI)」の考え方 - その1</div>
<p>
Springでは
<code>@Autowired</code> や <code>@LocalServerPort</code> のようなアノテーションを書くことによって、
実行時に必要な値やオブジェクトをフレームワークが自動的に作成・注入してくれるようになっている。
この機能を「<u>依存注入 (Dependency Injection, DI)</u>」と呼ぶ。
Spring では、コントローラーやデータベース接続など、アプリの動作に関連するほとんどのオブジェクトは
DI を使って作成させる (ビジネスロジックに関連するオブジェクトを除く)。
</p>

<div class=figure>
<div>
  <svg xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="1.1" width="340" height="220">
    <marker id="arrow" viewBox="-5 -5 10 10" orient="auto">
      <polygon points="-5,-5 5,0 -5,5" fill="black" stroke="none" />
    </marker>
    <g stroke="black" stroke-width="1" fill="none">
      <rect x="10" y="10" width="320" height="200" stroke-width="2" />
      <rect x="30" y="50" width="140" height="50" />
      <rect x="35" y="55" width="130" height="40" />
      <rect x="190" y="50" width="120" height="50" />
      <rect x="195" y="55" width="110" height="40" />
      <rect x="85" y="140" width="180" height="50" />
      <rect x="90" y="145" width="170" height="40" />
    </g>
    <g text-anchor="middle" style="font-size: 75%;">
      <text x="170" y="30">Application Context</text>
      <text x="100" y="80">TestRestTemplate</text>
      <text x="250" y="80">LocalServerPort</text>
      <text x="175" y="170">TodoAppApplicationTests</text>
    </g>
    <g stroke="black" fill="none" marker-end="url(#arrow)">
      <path d="M110,140 q-20,-5,-20,-35" stroke-width="2" stroke-dasharray="4,4" />
      <path d="M110,100 q20,5,20,35" stroke-width="4" />
      <path d="M230,140 q-20,-5,-20,-35" stroke-width="2" stroke-dasharray="4,4" />
      <path d="M230,100 q20,5,20,35" stroke-width="4" />
    </g>
    <g text-anchor="middle" style="font-size: 75%;">
      <text x="75" y="125">依存</text>
      <text x="145" y="125">注入</text>
      <text x="195" y="125">依存</text>
      <text x="265" y="125">注入</text>
    </g>
  </svg>
  <div class="caption">TestRestTemplate と LocalServerPort を TodoAppApplicationTests に注入する</div>
</div>
</div>

</div>

<li> 新しいファイル TodoController.kt を作成し、以下のように書く:
<pre>
package com.example.todoApp
...

@RestController
class TodoController {

    @GetMapping("/todos")
    fun getTodos(): String {
        return "Here are todos!"
    }

}
</pre>

<ul>
  <li> ふたたび <kbd><svg xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="1.1" width="10" height="10">
       <polygon fill=green stroke=none points="0,0 10,5 0,10" />
       </svg></kbd> ボタンを押してテストを実行し、成功していることを確認する。
  <li> テスト駆動開発の3ステップ:
    <ul>
      <li> まず失敗するテストを書く (Red)。
      <li> そのテストが成功するように、最小限のコードを書く (Green)。
      <li> テストが成功したら、必要に応じてコードをリファクタリングする (Refactor)。
    </ul>
</ul>

<div class=formula>
<div class=title>Spring における「依存注入 (DI)」の考え方 - その2</div>
<p>
Springにおける
<code>@RestController</code> や <code>@GetMapping</code> のようなアノテーションは、
依存注入のもう一方の側面を表している。
ここまでのコードでは明示的に <code>TodoController</code> を作成するロジックは存在していない。
にもかかわらず、<code>TodoController</code> オブジェクトが作成され、動作しているように見える。
</p>

<p>
ここでは、<code>@RestController</code> は、当該クラスが Spring Boot の DI候補として
利用可能であることを示す。さらに <code>@GetMapping</code> は、当該メソッドが
GET メソッドに対するハンドラとして利用可能であることを示す。
この2つのアノテーションが存在することによって、
Spring Boot は <code>hello()</code> メソッドの周囲に
HTTP リクエスト・レスポンスを処理する機構をくっつけ全体を Webサーバとして動作させる。
この仕組みを使って、数行で新しい Web API を作成することができる。
</p>

<div class=figure>
<div>
  <svg xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="1.1" width="320" height="200">
    <marker id="arrow" viewBox="-5 -5 10 10" orient="auto">
      <polygon points="-5,-5 5,0 -5,5" fill="black" stroke="none" />
    </marker>
    <g stroke="black" stroke-width="1" fill="none">
      <rect x="70" y="10" width="240" height="180" stroke-width="2" />
      <rect x="110" y="70" width="160" height="80" />
      <rect x="115" y="75" width="150" height="70" />
    </g>
    <g stroke="black" stroke-width="4" fill="none" marker-end="url(#arrow)">
      <path d="M40,60 l150,0 l0,25" />
      <path d="M190,130 l0,30 l-145,0" />
    </g>
    <g text-anchor="middle" style="font-size: 75%;">
      <text x="190" y="30">Application Context</text>
      <text x="190" y="105">TodoController</text>
      <text x="190" y="125">hello()</text>
      <text x="40" y="50">リクエスト</text>
      <text x="40" y="150">レスポンス</text>
    </g>
  </svg>
  <div class="caption">依存注入を使った APIエンドポイントの作成</div>
</div>
</div>

</div>

</ol>


<h2 id="repository">4. TodoRepositoryの作成</h2>

<ol class=spacy>
  <li> マイグレーションファイルを作成する。
    <code>resources</code> フォルダの下に <code>db/migration</code> というフォルダを作成し、
    ここにファイルを新規作成する:
<div class=file>
<div>src/main/resources/db/migration/V1__create_todos_table.sql:</div>
<pre>
CREATE TABLE todos (
    id SERIAL PRIMARY KEY,
    text TEXT
);
</pre>
</div>

<div class=formula>
<div class=title>データベースマイグレーションとは何か?</div>
<p>
一般に、アプリのビジネスロジックはデータベースの構造に依存する。
さらに、アプリを開発するにつれてデータベース構造は変化していく。
このため、データベースの変更履歴を管理する「マイグレーションツール」を使って
開発するのが一般的である。ここでは Spring との統合が容易な
<a href="https://flywaydb.org/">Flyway</a> というツールを使っている。
</p>
</div>

<div class=notice>
<div class=title>マイグレーションファイルを書くときの注意</div>
<ul>
  <li> ファイル名は <code><strong>V</strong>xxx__yyy.sql</code> のような形式にすること (先頭の <code>V</code> は大文字)。
  <li> 一度使われたマイグレーションファイルは内容を書き換えたり、ファイル名を変更したり、削除しないこと。
  <li> マイグレーションファイルがうまくいかない場合は、データベースを一度削除し、再度作成する (重要なデータが入ってない場合に限る)。
<pre>
$ <strong>dropdb tododb</strong>
$ <strong>createdb tododb</strong>
</pre>
</ul>
</div>

<li> PostgreSQLクライアントを起動し、"todos" テーブルができていることを確認する:
<pre>
$ <strong>psql tododb</strong>
psql (14.12 (Homebrew))
Type "help" for help.

tododb=# <strong>\d</strong>
                  List of relations
 Schema |         Name          |   Type   |  Owner   
--------+-----------------------+----------+----------
 public | flyway_schema_history | table    | postgres
 public | todos                 | table    | postgres
 public | todos_id_seq          | sequence | postgres
(3 rows)
</pre>

<li> テスト時に実行させる SQL ファイルを書く:
<div class=file>
<div>src/test/resources/insert_test_data.sql:</div>
<pre>
TRUNCATE TABLE todos;
INSERT INTO todos VALUES (1, 'foo');
INSERT INTO todos VALUES (2, 'bar');
</pre>
</div>

<li> APIが返す JSON型である Todoクラスを作成する (これはテストを書く必要はない)。
  Todo.kt ファイルを作成し、以下のように書く:
<pre>
package com.example.todoApp

data class Todo(val id: Long, val text: String)
</pre>

<div class=formula>
<div class=title>Kotlin の data class とは?</div>
<p>
Kotlin における data class は、データの格納に使うクラスを定義するためのショートカットである。
通常であれば、以下のようなクラス定義を書く必要があるが、data class の定義は自動でこれらを追加してくれる。
<pre class=small>
class Todo {
    val id: Long
    val text: String

    constructor(id: Long, text: String) {
        this.id = id
        this.text = text
    }

    getId(): Long { 
        return id 
    }

    getText(): String {
        return text
    }

    ...
}
</pre>
</p>
</div>

<li> テストを TodoAppApplicationTests.kt に追加する:
<pre>
package com.example.todoApp
...

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
<span class=bgy>@Sql("/insert_test_data.sql")</span>
class TodoAppApplicationTests
    ...
<div class=bgy>    @Test
    fun `GETリクエストはTodoオブジェクトのリストを返す`() {
        <em>// localhost/todos に GETリクエストを送り、レスポンスを Todoオブジェクトの配列として解釈する。</em>
        val response = restTemplate.getForEntity("http://localhost:$port/todos", Array&lt;Todo&gt;::class.java)
        <em>// レスポンスの Content-Type は application/json であること。</em>
        assertThat(response.headers.contentType, equalTo(MediaType.APPLICATION_JSON))
        <em>// 配列は2つの要素をもつこと。</em>
        val todos = response.body!!
        assertThat(todos.size, equalTo(2))
        <em>// 最初の要素は id=1 であり、text が "foo" であること。</em>
        assertThat(todos[0].id, equalTo(1))
        assertThat(todos[0].text, equalTo("foo"))
        <em>// 次の要素は id=2 であり、text が "bar" であること。</em>
        assertThat(todos[1].id, equalTo(2))
        assertThat(todos[1].text, equalTo("bar"))
    }
</div>    ...
</pre>
<p>
<kbd><svg xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="1.1" width="10" height="10">
       <polygon fill=green stroke=none points="0,0 10,5 0,10" />
       </svg></kbd> ボタンを押してテストを実行し、失敗することを確認する。
</p>

<li> 最初に、データベースとの入出力をおこなうリポジトリ (Repository) オブジェクトを定義する。
TodoRepository.kt ファイルを作成し、以下のように書く:
<pre>
package com.example.todoApp
...

@Component
class TodoRowMapper : RowMapper<Todo> {
    override fun mapRow(rs: ResultSet, rowNum: Int): Todo {
        return Todo(rs.getLong(1), rs.getString(2))
    }
}

@Repository
class TodoRepository(
    @Autowired val jdbcTemplate: JdbcTemplate,
    @Autowired val todoRowMapper: TodoRowMapper
) {
    fun getTodos(): List&lt;Todo&gt; {
        return jdbcTemplate.query("SELECT id, text FROM todos", todoRowMapper)
    }
}
</pre>

<div class=note>
<div class=title>ぜひとも覚えたい IntelliJ IDEA の機能 その2</div>
<p>
コード中のクラス名・関数名・変数名などを
<kbd>Command &#x2318;</kbd> キーを押しながらクリックすると、
そのクラスや関数の定義箇所に移動する。
</p>
</div>

<li> つぎに、TestController を変更してリポジトリを呼び出し、
  GETメソッドの返り値を返すようなメソッドを追加する:
<pre>
package com.example.todoApp
...

@RestController
class TodoController(<span class=bgy>val todoRepository: TodoRepository</span>) {
    ...
<div class=bgy>    @GetMapping("/todos")
    fun getTodos(): List&lt;Todo&gt; {
        return todoRepository.getTodos()
    }
</div>    ...
</pre>

<p> TodoAppApplicationTests に戻り、
<kbd><svg xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="1.1" width="10" height="10">
       <polygon fill=green stroke=none points="0,0 10,5 0,10" />
       </svg></kbd> ボタンを押してテストを実行し、成功することを確認する。
</p>

</ol>

<p>
  以上で Todoテーブルの内容を取得する GET エンドポイントができた。
</p>


<h2 id="post">5. POSTエンドポイントの作成</h2>

<ol class=spacy>
  <li> POSTリクエストで受け取る JSONの型を定義する:
<pre>
package com.example.todoApp

data class TodoRequest(val text: String)
</pre>

<li> テストを書いて実装する:
<pre>
    @Test
    fun `POSTリクエストはOKステータスを返す`() {
        <em>// localhost/todos に POSTリクエストを送る。このときのボディは {"text": "hello"}</em>
        val request = TodoRequest("hello")
        val response = restTemplate.postForEntity("http://localhost:$port/todos", request, String::class.java)
        <em>// レスポンスのステータスコードは OK であること。</em>
        assertThat(response.statusCode, equalTo(HttpStatus.OK))
    }
</pre>

<li> テストを書いて実装する。
  このとき「正しくデータベースに追加できているか」をテストで確認するためには、以下のようにする:
<ol>
  <li> 最初に <code>GET /todos</code> を実行し、得られた Todoのリストを記憶しておく。
  <li> <code>POST /todos</code> でなにか適当な Todoをひとつ追加する。
  <li> ふたたび <code>GET /todos</code> を実行し、得られた Todoリストに
    新しい Todo項目が追加されているかどうかをチェックする。
</ol>
<pre>
    @Test
    fun `POSTリクエストはTodoオブジェクトを格納する`() {
        <em>// localhost/todos に GETリクエストを送り、レスポンスを Todoオブジェクトの配列として解釈する。</em>
        ...
        <em>// このときのレスポンスを todos1 として記憶。</em>
        ...

        <em>// localhost/todos に POSTリクエストを送る。このときのボディは {"text": "hello"}</em>
        ...

        <em>// ふたたび localhost/todos に GETリクエストを送り、レスポンスを Todoオブジェクトの配列として解釈する。</em>
        ...
        <em>// このときのレスポンスを todos2 として記憶。</em>
        ...

        <em>// 配列 todos2 は、配列 todos1 よりも 1 要素だけ多い。</em>
        assertThat(todos2.size, equalTo(todos1.size + 1))
        <em>// 配列 todos2 には "hello" をもつTodoオブジェクトが含まれている。</em>
        assertThat(todos2.map { todo: Todo -&gt; todo.text }, hasItem("hello"))
    }
</pre>

<div class=formula>
<div class=title>Spring 用語解説</div>
<dl>
  <dt> Bean と POJO
  <dd> Spring Bean は、Springによって作成・管理されるオブジェクト。
    これに対してコード上で作成する (newする) オブジェクトは POJO (Plain Old Java Object) と呼ばれる。
    一般に、アプリの動作に必要なオブジェクトには Bean を使い、ビジネスロジックで使うオブジェクトは POJO を使う。
    <p>
      <u>注意:</u>
      "Java Bean" という用語もあるが、
      これは特定の規則に従って作られた Javaオブジェクトのことをさし、
      <strong>Spring Beanとは別物</strong>。
    </p>

  <dt> Spring IoC コンテナと Application Context
  <dd> Spring IoC (Inversion of Control) コンテナには、
    Spring によって作成・管理される Bean が入っている。
    Spring は必要に応じて Beanを作成し、依存注入をおこなう。
    "Application Context" もほぼ同義。
    <div class=figure><div>
  <svg xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       version="1.1" width="340" height="130">
    <marker id="arrow" viewBox="-5 -5 10 10" orient="auto">
      <polygon points="-5,-5 5,0 -5,5" fill="black" stroke="none" />
    </marker>
    <g stroke="black" stroke-width="1" fill="none">
      <rect x="10" y="10" width="320" height="110" stroke-width="2" />
      <rect x="30" y="50" width="80" height="50" />
      <rect x="35" y="55" width="70" height="40" />
      <rect x="130" y="50" width="80" height="50" />
      <rect x="135" y="55" width="70" height="40" />
      <rect x="230" y="50" width="80" height="50" />
      <rect x="235" y="55" width="70" height="40" />
    </g>
    <g text-anchor="middle" style="font-size: 75%;">
      <text x="170" y="30">Application Context</text>
      <text x="70" y="80">Bean</text>
      <text x="170" y="80">Bean</text>
      <text x="270" y="80">...</text>
    </g>
  </svg>
</div>
</div>

  <dt> @Controller, @Repository, @Service, @Component など
  <dd> Spring Bean の候補となるクラスにつけられるアノテーション。
    役割によって使い分ける。
    Spring Boot では起動時にこれらのアノテーションが自動検出されるため、
    何も設定もしなくても依存注入が可能になる。
    <ul>
      <li> <code>@Controller</code> … Web APIのエンドポイントを提供する。
      <li> <code>@Repository</code> … データの保存・変更・削除等の機能を提供する。
      <li> <code>@Service</code> … ビジネスロジックに関連した機能を提供する。
      <li> <code>@Component</code> … 上記以外の目的で使われる。
    </ul>
    
</dl>
</div>

</ol>


<h2 id="conclusion">6. おわりに</h2>

<p>Spring Boot の長所:</p>
<ul>
  <li> 最小限のコードで信頼性のあるサービスを開発できる。
  <li> データベースとの連携、クラウドサービスの利用、認証・認可の使用など、一般的なアプリで必要な機能がほぼ揃っている。
  <li> テスト機能が充実しており、テスト駆動開発 (TDD) に向いている。
  <li> 「エンタープライズ」アプリを設計・開発するためのノウハウが詰まっており、保守しやすいコードが書ける。
</ul>

<p>Spring Boot の短所:</p>
<ul>
  <li> アノテーションの使い方など、「Spring流」でやる方法を覚えるのに時間がかかる。
  <li> 多くのオブジェクトが自動的に作成されるため、制御の流れがわかりにくい。
  <li> エラー (データベース接続エラーなど) が発生した場合は「依存注入の失敗」として扱われるため、
    原因を特定するまでに時間がかかる場合がある。
</ul>

<h3 id="references">参考文献</h3>

<ul>
  <li> <a target="_blank" href="https://developer.mozilla.org/ja/docs/Web/HTTP/Status">HTTP レスポンスステータスコード</a>
  <li> <a target="_blank" href="https://www.tohoho-web.com/ex/kotlin.html">とほほのKotlin入門</a>
  <li> <a target="_blank" href="https://licensecounter.jp/devops-hub/blog/spring-boot1/">Spring Bootってなにがいいの</a>
  <li> <a target="_blank" href="https://spring.pleiades.io/spring-boot/">Spring Boot リファレンスマニュアル</a>
  <li> <a target="_blank" href="https://learning-collection.com/spring-boot%E3%81%A7%E3%82%88%E3%81%8F%E4%BD%BF%E3%81%86%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E4%B8%80%E8%A6%A7/">Spring Bootでよく使うアノテーション一覧</a>
  <li> <a target="_blank" href="https://www.tohoho-web.com/ex/postgresql.html">とほほのPostgreSQL入門</a>
</ul>

<hr>
<address>Yusuke Shinyama</address>
